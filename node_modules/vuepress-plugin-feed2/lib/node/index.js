import{colors as f,getDirname as Q,path as X,fs as O}from"@vuepress/utils";import{isArray as v,isPlainObject as C,isLinkHttp as $,removeEndingSlash as w,removeLeadingSlash as j,ensureEndingSlash as W,isFunction as g}from"@vuepress/shared";import{encodeXMLContent as L,encodeCDATA as Y,Logger as Z,deepAssign as tt,isUrl as A,isAbsoluteUrl as N,HTML_TAGS as et,SVG_TAGS as it,getPageText as at,getAuthor as M,getCategory as nt,getPageExcerpt as st}from"vuepress-shared/node";import{js2xml as G}from"xml-js";import{load as rt}from"cheerio";const R=e=>Object.fromEntries(Object.entries(e).map(([t,i])=>t==="_attributes"&&i?[t,Object.fromEntries(Object.entries(i).map(([a,s])=>[a,s?L(s.toString()):void 0]))]:t==="_text"?[t,L(i.toString())]:t==="_cdata"?[t,Y(i)]:t==="_comment"||t==="_instruction"?[t,i]:v(i)?[t,i.map(a=>R(a))]:C(i)?[t,R(i)]:[t,L(String(i))])),P="vuepress-plugin-feed2",_=new Z(P),H=(e,t)=>!e||!(e instanceof Date)?1:!t||!(t instanceof Date)?-1:t.getTime()-e.getTime(),h=(e,t="",i="")=>`${$(e)?w(e):`https://${w(e)}`}${t}${j(i)}`,ot=(e="")=>`image/${e==="jpg"?"jpeg":e==="svg"?"svg+xml":e==="jpeg"||e==="png"||e==="bmp"||e==="gif"||e==="webp"?e:""}`,lt=({options:e,deprecatedOption:t,newOption:i,msg:a="",scope:s=""})=>{if(t in e){if(_.warn(`${f.magenta(t)} is ${f.yellow("deprecated")}${s?` in ${s}`:""}, please use "${f.magenta(i)}" instead.${a?`
${a}`:""}`),i.includes(".")){const n=i.split(".");let r=e;n.forEach((o,l)=>{l!==n.length-1?(r[o]=r[o]||{},r=r[o]):r[o]=e[t]})}else e[i]=e[t];delete e[t]}},pt=(e,t,i="",a="")=>{t in e&&(_.error(`"${f.magenta(t)}" is ${f.red("removed")}${a?`, please use ${f.magenta(a)} instead.`:" and no longer supported"}${i?`
${i}`:""}`),a||delete e[t])},ut=e=>{var t,i,a,s,n,r,o,l,p,u,c,m;e.atom=((i=(t=e.output)==null?void 0:t.atom)==null?void 0:i.enable)??!0,e.json=((s=(a=e.output)==null?void 0:a.json)==null?void 0:s.enable)??!0,e.rss=((r=(n=e.output)==null?void 0:n.rss)==null?void 0:r.enable)??!0,e.atomOutputFilename=((l=(o=e.output)==null?void 0:o.atom)==null?void 0:l.path)??"atom.xml",e.jsonOutputFilename=((u=(p=e.output)==null?void 0:p.json)==null?void 0:u.path)??"feed.json",e.jsonOutputFilename=((m=(c=e.output)==null?void 0:c.rss)==null?void 0:m.path)??"rss.xml",lt({options:e,deprecatedOption:"customElements",newOption:"removedElements"}),pt(e,"output")},ct=Q(import.meta.url),J=W(X.resolve(ct,"../../templates")),mt=e=>e.hostname?(e.hostname=$(e.hostname)?w(e.hostname):`https://${w(e.hostname)}`,!0):!1,ht=e=>e.locales&&Object.entries(e.locales).some(([,{atom:t,json:i,rss:a}])=>t||i||a)||Boolean(e.atom||e.json||e.rss),dt=({siteData:e},t)=>Object.fromEntries(Object.keys({"/":{},...e.locales}).map(i=>{var a;return[i,{filter:({frontmatter:s,filePathRelative:n})=>!(s.home||!n||s.article===!1||s.feed===!1),sorter:(s,n)=>{var r,o,l,p;return H((r=s.data.git)!=null&&r.createdTime?new Date((o=s.data.git)==null?void 0:o.createdTime):s.frontmatter.date,(l=n.data.git)!=null&&l.createdTime?new Date((p=n.data.git)==null?void 0:p.createdTime):n.frontmatter.date)},...t,...(a=t.locales)==null?void 0:a[i],hostname:t.hostname}]})),gt=(e,t,i="")=>{var a,s,n,r,o,l,p,u,c,m;const{base:d}=e.options,{title:b,description:y,lang:x,locales:k}=e.siteData,{channel:F={},hostname:S,icon:E,image:U}=t,I=v((a=t.channel)==null?void 0:a.author)?(n=(s=t.channel)==null?void 0:s.author[0])==null?void 0:n.name:(o=(r=t.channel)==null?void 0:r.author)==null?void 0:o.name,z={title:((l=k[i])==null?void 0:l.title)||b||((p=k["/"])==null?void 0:p.title)||"",link:h(S,d,i),description:((u=k[i])==null?void 0:u.description)||y||((c=k["/"])==null?void 0:c.description)||"",language:((m=k[i])==null?void 0:m.lang)||x,copyright:I?`Copyright by ${I}`:"",pubDate:new Date,lastUpdated:new Date,...E?{icon:$(E)?E:h(S,d,E)}:{},...U?{image:$(U)?U:h(S,d,U)}:{}};return tt(z,F,{...F.icon?{icon:$(F.icon)?F.icon:h(S,d,F.icon)}:{},...F.image?{image:$(F.image)?F.image:h(S,d,F.image)}:{}})},D=(e,t="/")=>({atomOutputFilename:`${j(t)}${e.atomOutputFilename||"atom.xml"}`,atomXslFilename:`${j(t)}${e.atomXslFilename||"atom.xsl"}`,atomXslTemplate:e.atomXslTemplate||`${J}atom.xsl`,jsonOutputFilename:`${j(t)}${e.jsonOutputFilename||"feed.json"}`,rssOutputFilename:`${j(t)}${e.rssOutputFilename||"rss.xml"}`,rssXslFilename:`${j(t)}${e.rssXslFilename||"rss.xsl"}`,rssXslTemplate:e.rssXslTemplate||`${J}atom.xsl`}),ft=({options:{base:e}},t,i)=>{const{hostname:a}=t,{atomOutputFilename:s,atomXslFilename:n,jsonOutputFilename:r,rssOutputFilename:o,rssXslFilename:l}=D(t,i);return{localePath:i,atom:h(a,e,s),atomXsl:h(a,e,n),json:h(a,e,r),rss:h(a,e,o),rssXsl:h(a,e,l)}},T=e=>{const{name:t="Unknown",email:i,url:a}=e;return{name:t,...i?{email:i}:{},...a?{uri:a}:{}}},bt=e=>{const{name:t,scheme:i=""}=e;return{_attributes:{term:t,scheme:i}}},yt=e=>{const{channel:t,links:i}=e.options,a={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},_instruction:{"xml-stylesheet":`type="text/xsl" href="${i.atomXsl}"`},feed:{_attributes:{xmlns:"http://www.w3.org/2005/Atom",...t.language?{"xml:lang":t.language}:{}},id:t.link,title:t.title,...t.description?{subtitle:t.description}:{},...t.author?{author:v(t.author)?t.author.map(s=>T(s)):[T(t.author)]}:{},...t.icon?{icon:t.icon}:{},...t.image?{logo:t.image}:{},...t.copyright?{rights:t.copyright}:{},updated:t.lastUpdated?t.lastUpdated.toISOString():new Date().toISOString(),generator:P,link:[{_attributes:{rel:"self",href:i.atom}}]}};return t.link&&a.feed.link.push({_attributes:{rel:"alternate",href:t.link}}),t.hub&&a.feed.link.push({_attributes:{rel:"hub",href:t.hub}}),t.image&&(a.feed.logo=t.image),t.icon&&(a.feed.icon=t.icon),t.copyright&&(a.feed.rights=t.copyright),a.feed.category=Array.from(e.categories).map(s=>({_attributes:{term:s}})),a.feed.contributor=Array.from(e.contributors).filter(s=>s.name).map(s=>T(s)),a.feed.entry=e.items.map(s=>{const n={title:{_attributes:{type:"text"},_text:s.title},id:s.guid||s.link,link:{_attributes:{href:s.link}},updated:s.lastUpdated.toISOString()};return s.summary?n.summary={_attributes:{type:"html"},_cdata:s.summary}:s.description&&(n.summary={_attributes:{type:"text"},_text:s.description}),s.content&&(n.content={_attributes:{type:"html"},_cdata:s.content}),s.author&&(n.author=s.author.filter(r=>r.name).map(r=>T(r))),s.category&&(n.category=s.category.map(r=>bt(r))),s.contributor&&(n.contributor=s.contributor.map(r=>T(r))),s.pubDate&&(n.published=s.pubDate.toISOString()),s.copyright&&(n.rights=s.copyright),n}),G(R(a),{compact:!0,ignoreComment:!0,spaces:2})},B=e=>({name:e.name,...e.url?{url:e.url}:{},...e.avatar?{avatar:e.avatar}:{}}),Ot=e=>{const{channel:t,links:i}=e.options,a={version:"https://jsonfeed.org/version/1.1",title:t.title,home_page_url:t.link,feed_url:i.json};t.description&&(a.description=t.description),t.image&&(a.icon=t.image),t.icon&&(a.favicon=t.icon);const s=(v(t.author)?t.author:t.author?[t.author]:[]).filter(n=>Boolean(n==null?void 0:n.name));return s.length&&(a.authors=s.map(n=>B(n))),a.items=e.items.map(n=>{const r={title:n.title,url:n.link,id:n.guid||n.link,...n.description?{summary:n.description}:{},content_html:n.content};return n.image&&(r.image=n.image),n.pubDate&&(r.date_published=n.pubDate.toISOString()),n.lastUpdated&&(r.date_modified=n.lastUpdated.toISOString()),v(n.author)&&(r.authors=n.author.filter(o=>o.name).map(o=>B(o))),n.category&&(r.tags=n.category.filter(o=>o.name).map(o=>o.name)),r}),JSON.stringify(a,null,2)},vt=e=>{const{name:t,domain:i}=e;return{_text:t,...i?{_attributes:{domain:i}}:{}}},Ft=e=>{const t=e.guid||e.link;return{...A(t)?{}:{_attributes:{isPermaLink:"false"}},_text:t}},_t=e=>({_attributes:{url:e.url,...e.length?{length:e.length}:{},...e.type?{type:e.type}:{}}}),xt=e=>{const{links:t,channel:i}=e.options;let a=!1;const s={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},_instruction:{"xml-stylesheet":`type="text/xsl" href="${t.rssXsl}"`},rss:{_attributes:{version:"2.0","xmlns:atom":"http://www.w3.org/2005/Atom"},channel:{"atom:link":{_attributes:{href:t.rss,rel:"self",type:"application/rss+xml"}},title:{_text:i.title},link:{_text:i.link},description:{_text:i.description},language:{_text:i.language},pubDate:{_text:i.pubDate?i.pubDate.toUTCString():new Date().toUTCString()},lastBuildDate:{_text:i.lastUpdated?i.lastUpdated.toUTCString():new Date().toUTCString()},generator:{_text:P},docs:{_text:"https://validator.w3.org/feed/docs/rss2.html"}}}};return i.copyright&&(s.rss.channel.copyright={_text:i.copyright}),i.ttl&&(s.rss.channel.ttl={_text:i.ttl.toString()}),i.image&&(s.rss.channel.image={title:{_text:i.title},url:{_text:i.image},link:{_text:i.link}}),s.rss.channel.category=Array.from(e.categories).map(n=>({_text:n})),s.rss.channel.item=e.items.map(n=>{const r={title:{_text:n.title},link:{_text:n.link},guid:Ft(n),source:{_attributes:{url:t.rss},_text:n.title}};if(n.description&&(r.description={_text:n.description}),n.author){const o=n.author.find(l=>l.email&&l.name);o&&(r.author={_text:`${o.email} (${o.name})`})}return n.category&&(r.category=n.category.filter(o=>o.name).map(o=>vt(o))),n.comments&&(r.comments={_text:n.link}),n.pubDate&&(r.pubDate={_text:n.pubDate.toUTCString()}),n.content&&(a=!0,r["content:encoded"]={_cdata:n.content}),n.enclosure&&(r.enclosure=_t(n.enclosure)),r}),a&&(s.rss._attributes["xmlns:content"]="http://purl.org/rss/1.0/modules/content/",s.rss._attributes["xmlns:dc"]="http://purl.org/dc/elements/1.1/"),G(R(s),{compact:!0,ignoreComment:!0,spaces:2})};class $t{constructor(t){this.options=t,this.items=[],this.categories=new Set,this._contributorKeys=new Set,this.contributors=[],this.addItem=i=>{this.items.push(i)},this.addCategory=i=>{this.categories.add(i)},this.addContributor=i=>{const a=i.email||i.name;a&&!this._contributorKeys.has(a)&&(this._contributorKeys.add(a),this.contributors.push(i))},this.atom=()=>yt(this),this.rss=()=>xt(this),this.json=()=>Ot(this)}}const jt=["h1","h2","h3","h4","h5","h6"],K=(e,t,i)=>{if(e.type==="tag"){if(e.tagName==="img"){const{src:a}=e.attribs;if(!$(a)&&!N(a))return null}return[e.attribs.class,e.attribs.id].some(a=>["table-of-contents","toc"].includes(a))||e.tagName==="pre"?null:et.includes(e.tagName)||it.includes(e.tagName)?(jt.includes(e.tagName)&&(delete e.attribs.id,delete e.attribs.tabindex,e.children=e.children.filter(a=>a.type!=="tag"||a.tagName!=="a"||a.attribs.class!=="header-anchor")),e.tagName==="code"&&delete e.attribs["v-pre"],e.children=q(e.children,t,i),e):e.tagName==="routerlink"?(e.tagName="a",e.attribs.href=`${w(t)}${e.attribs.to}`,e.attribs.target="blank",delete e.attribs.to,e.children=q(e.children,t,i),e):i(e.tagName)?e:null}return e},q=(e,t,i)=>v(e)?e.map(a=>K(a,t,i)).filter(a=>a!==null):[],V=rt(""),Dt=(e,t,i)=>{const a=e.dir.dest(t.path),s=O.existsSync(a)?O.readFileSync(a,"utf-8"):t.contentRendered;let n="";const r=V.parseHTML(s)||[];for(const o of r){const l=K(o,e.options.base,i);l&&(n+=`${V.html(l)}`)}return n};class kt{constructor(t,i,a,s){this.app=t,this.options=i,this.page=a,this.feed=s,this.base=this.app.options.base,this.frontmatter=a.frontmatter,this.getter=i.getter||{},this.pageFeedOptions=this.frontmatter.feed||{},this.shouldRemoveElement=n=>{const{removedElements:r}=this.options;return v(r)?r.some(o=>o instanceof RegExp?o.test(n):o===n):g(r)?r(n):!1}}get title(){return g(this.getter.title)?this.getter.title(this.page):this.pageFeedOptions.title||this.page.title}get link(){return g(this.getter.link)?this.getter.link(this.page):h(this.options.hostname,this.base,this.page.path)}get description(){if(g(this.getter.description))return this.getter.description(this.page);if(this.pageFeedOptions.description)return this.pageFeedOptions.description;if(this.frontmatter.description)return this.frontmatter.description;const t=at(this.page);return t.length>180?`${t.slice(0,177)}...`:t}get author(){var t,i;return g(this.getter.author)?this.getter.author(this.page):v(this.pageFeedOptions.author)?this.pageFeedOptions.author:C(this.pageFeedOptions.author)?[this.pageFeedOptions.author]:this.frontmatter.author===!1?[]:this.frontmatter.author?M(this.frontmatter.author):(t=this.options.channel)!=null&&t.author?M((i=this.options.channel)==null?void 0:i.author):[]}get category(){if(g(this.getter.category))return this.getter.category(this.page);if(v(this.pageFeedOptions.category))return this.pageFeedOptions.category;if(C(this.pageFeedOptions.category))return[this.pageFeedOptions.category];const{categories:t,category:i=t}=this.frontmatter;return nt(i).map(a=>({name:a}))}get enclosure(){return g(this.getter.enclosure)?this.getter.enclosure(this.page):this.image?{url:this.image,type:ot(this.image.split(".").pop())}:null}get guid(){return this.pageFeedOptions.guid||this.link}get pubDate(){if(g(this.getter.publishDate))return this.getter.publishDate(this.page);const{time:t,date:i=t}=this.page.frontmatter,{createdTime:a}=this.page.data.git||{};return i&&i instanceof Date?i:a?new Date(a):null}get lastUpdated(){if(g(this.getter.lastUpdateDate))return this.getter.lastUpdateDate(this.page);const{updatedTime:t}=this.page.data.git||{};return t?new Date(t):new Date}get excerpt(){return g(this.getter.excerpt)?this.getter.excerpt(this.page):this.pageFeedOptions.summary?this.pageFeedOptions.summary:st(this.app,this.page,{isCustomElement:this.shouldRemoveElement})}get content(){return g(this.getter.content)?this.getter.content(this.page):this.pageFeedOptions.content?this.pageFeedOptions.content:Dt(this.app,this.page,this.shouldRemoveElement)}get image(){if(g(this.getter.image))return this.getter.image(this.page);const{banner:t,cover:i}=this.frontmatter;if(t){if(N(t))return h(this.options.hostname,this.app.options.base,t);if(A(t))return t}if(i){if(N(i))return h(this.options.hostname,this.app.options.base,i);if(A(i))return i}const a=/!\[.*?\]\((.*?)\)/iu.exec(this.page.content);if(a){if(N(a[1]))return h(this.options.hostname,this.app.options.base,a[1]);if(A(a[1]))return a[1]}return null}get contributor(){return g(this.getter.contributor)?this.getter.contributor(this.page):v(this.pageFeedOptions.contributor)?this.pageFeedOptions.contributor:C(this.pageFeedOptions.contributor)?[this.pageFeedOptions.contributor]:this.author}get copyright(){if(g(this.getter.copyright))return this.getter.copyright(this.page);if(this.frontmatter.copyright)return this.frontmatter.copyright;const t=this.author[0];return t!=null&&t.name?`Copyright by ${t.name}`:null}getFeedItem(){const{author:t,category:i,content:a,contributor:s,copyright:n,description:r,enclosure:o,excerpt:l,guid:p,image:u,lastUpdated:c,link:m,pubDate:d,title:b}=this;return!b&&!r?null:(i&&i.forEach(y=>this.feed.addCategory(y.name)),s&&s.forEach(y=>this.feed.addContributor(y)),{title:b,link:m,guid:p,lastUpdated:c,content:a,author:t,contributor:s,...r?{description:r}:{},...l?{summary:l}:{},...i?{category:i}:{},...o?{enclosure:o}:{},...d?{pubDate:d}:{},...u?{image:u}:{},...n?{copyright:n}:{}})}}class St{constructor(t,i){this.app=t,this.options=i,this.feedMap=Object.fromEntries(Object.entries(i).map(([a,s])=>[a,new $t({channel:gt(t,s,a),links:ft(t,s,a)})]))}addPages(t){const i=this.feedMap[t],a=this.options[t],{count:s=100,filter:n=({frontmatter:p,filePathRelative:u})=>!(p.home||!u||p.article===!1||p.feed===!1),sorter:r=(p,u)=>{var c,m,d,b;return H((c=p.data.git)!=null&&c.createdTime?new Date((m=p.data.git)==null?void 0:m.createdTime):p.frontmatter.date,(d=u.data.git)!=null&&d.createdTime?new Date((b=u.data.git)==null?void 0:b.createdTime):u.frontmatter.date)}}=a,o=this.app.pages.filter(p=>p.pathLocale===t).filter(n).sort(r).slice(0,s);let l=0;for(const p of o){const u=new kt(this.app,a,p,i).getFeedItem();u&&(i.addItem(u),l+=1)}_.succeed(`added ${f.cyan(`${l} page${l>1?"s":""}`)} as feed item${l>1?"s":""} in route ${f.cyan(t)}`)}async generateFeed(){const{dest:t}=this.app.dir;await Promise.all([...Object.entries(this.options).map(async([i,a])=>{if(a.atom||a.json||a.rss){const s=this.feedMap[i],{atomOutputFilename:n,jsonOutputFilename:r,rssOutputFilename:o}=D(a,i);this.addPages(i),a.atom&&(await O.ensureDir(X.dirname(t(n))),await O.outputFile(t(n),s.atom()),_.succeed(`Atom feed file generated and saved to ${f.cyan(`/${n}`)}`)),a.json&&(await O.ensureDir(X.dirname(t(r))),await O.outputFile(t(r),s.json()),_.succeed(`JSON feed file generated and saved to ${f.cyan(`/${r}`)}`)),a.rss&&(await O.ensureDir(X.dirname(t(o))),await O.outputFile(t(o),s.rss()),_.succeed(`RSS feed file generated and saved to ${f.cyan(`/${o}`)}`))}}),Object.entries(this.options).filter(([,{atom:i}])=>i).map(([i,a])=>{const{atomXslTemplate:s,atomXslFilename:n}=D(a,i);return O.copyFile(s,t(n))}),Object.entries(this.options).filter(([,{rss:i}])=>i).map(([i,a])=>{const{rssXslFilename:s,rssXslTemplate:n}=D(a,i);return O.copyFile(n,t(s))})])}}const wt=(e,t)=>{const{base:i}=e.options,{siteData:a}=e,s=Object.keys(t);if(s.length===1){const{atomOutputFilename:n,jsonOutputFilename:r,rssOutputFilename:o}=D(t["/"]),{atom:l,json:p,rss:u,hostname:c}=t["/"],m=(d,b,y)=>{var x;return["link",{rel:"alternate",type:y,href:h(c,i,b),title:`${a.title||((x=a.locales["/"])==null?void 0:x.title)||""} ${d} Feed`}]};a.head||(a.head=[]),l&&a.head.push(m("Atom",n,"application/atom+xml")),p&&a.head.push(m("JSON",r,"application/json")),u&&a.head.push(m("RSS",o,"application/rss+xml"))}else e.pages.forEach(n=>{const{pathLocale:r}=n,o=t[r];if(s.includes(r)){const{atomOutputFilename:l,jsonOutputFilename:p,rssOutputFilename:u}=D(o,r),c=(m,d,b)=>{var y,x;return["link",{rel:"alternate",type:b,href:h(o.hostname,i,d),title:`${((y=a.locales[r])==null?void 0:y.title)||a.title||((x=a.locales["/"])==null?void 0:x.title)||""} ${m} Feed`}]};n.frontmatter.head||(n.frontmatter.head=[]),o.atom&&n.frontmatter.head.push(c("Atom",l,"application/atom+xml")),o.json&&n.frontmatter.head.push(c("JSON",p,"application/json")),o.rss&&n.frontmatter.head.push(c("RSS",u,"application/rss+xml"))}})},Tt=(e,t=!0)=>i=>{t&&ut(e),i.env.isDebug&&_.info("Options:",e);const a={name:"vuepress-plugin-feed2"};if(!mt(e))return _.error(`Option ${f.magenta("hostname")} is required!`),a;if(!ht(e))return _.info("No requested output, the plugin won’t start!"),a;const s=dt(i,e);return{...a,onPrepared:n=>wt(n,s),onGenerated:async n=>{await new St(n,s).generateFeed()}}};export{Tt as feedPlugin};
//# sourceMappingURL=index.js.map
